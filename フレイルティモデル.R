library(readr)
library(survival)
addicts <- read_csv("Documents/??????/?????????/M2/??????????????????/addicts.csv", col_types = cols(X1 = col_skip()))
head(addicts)

#????????????object
Y = Surv(addicts$survt, addicts$status ==1)

# ????????????????????????1
kmfit1 = survfit(Y ~ 1)
summary(kmfit1)

# 365??????????????????????????????
summary(kmfit1, times = 365)

# ????????????????????????2
kmfit2 = survfit(Y ~ addicts$clinic)
kmfit2

plot(kmfit2, lty = c("solid", "dashed"), col=c("black", "grey"), mark.t=TRUE,
     xlab="survival time in days", ylab = "survival probabilities")
legend("topright", c("Clinic1", "Clinic2"), lty = c("solid", "dashed"),col=c("black", "grey"))

# clinic?????????????????????????????????(?????????????????????????????????)
survdiff(Y ~ addicts$clinic)
# ??????
survdiff(Y ~ clinic + strata(prison), data=addicts)


# -----2??????????????????????????????(?????????)-----
plot(kmfit2, fun="cloglog", xlab="time in days using logarithmic scale", ylab = "log-log survival",
     main="log-log curves by clinic")
# ??????loglogplot
kmfit3 = summary(kmfit2)
kmfit4 = data.frame(kmfit3$strata, kmfit3$time, kmfit3$surv) 
names(kmfit4) = c("clinic", "time", "survival")
clinic1 = kmfit4[kmfit4$clinic == "addicts$clinic=1",]
clinic2 = kmfit4[kmfit4$clinic == "addicts$clinic=2",]
plot(clinic1$time, log(-log(clinic1$survival)), xlab="time in days using logarithmic scale", 
     ylab = "log-log survival",xlim = c(0, 800), col="black", type="l", lty="solid", 
     main="log-log curves by clinic")
par(new=T)
plot(clinic2$time, log(-log(clinic2$survival)), axes=F, xlab="time in days using logarithmic scale", 
     ylab = "log-log survival",xlim = c(0, 800), col="grey50", type="l", lty="dashed", 
     main="log-log curves by clinic")
legend("bottomright", c("Clinic1", "Clinic2"), lty = c("solid", "dashed"),col=c("black", "grey50"))
par(new=F)

# -----3cox????????????????????????????????????-----
coxph(Y ~ prison + dose + clinic, data = addicts)
summary(coxph(Y ~ prison + dose + clinic, data = addicts))

# ????????????
mod1 = coxph(Y ~ prison + dose + clinic, data = addicts)
mod2 = coxph(Y ~ prison + dose + clinic + clinic*prison + clinic*dose, data = addicts)
names(mod2)
#  ????????????
mod2$loglik
# ???????????????
(-2)*(mod1$loglik[2] - mod2$loglik[2])
LRT = (-2)*(mod1$loglik[2] - mod2$loglik[2])
Pvalue = 1 - pchisq(LRT, 2)
Pvalue # ?????????p=0.1638?????????????????????

# -----4??????cox??????????????????-----
"2????????????clinic?????????????????????????????????????????????????????????prison???dose????????????????????????????????????,
clinic?????????????????????????????????cox???????????????????????????"
# ??????cox
coxph(Y ~ prison + dose + strata(clinic), data = addicts)
# ???????????????
coxph(Y ~ prison + dose + clinic:prison + clinic:dose + strata(clinic), data = addicts)
# ???????????????clinic2?????????
addicts$clinic2 = addicts$clinic-2
summary(coxph(Y ~ prison + dose + clinic2:prison + clinic2:dose + strata(clinic2), data = addicts))


# -----5??????????????????????????????????????????????????????-----
mod1 = coxph(Y ~ prison + dose + clinic, data = addicts)
cox.zph(mod1, transform=rank) #rank????????????????????????????????????????????????Schoenfeld???????????????????????????????????????
plot(cox.zph(mod1, transform=rank), se=F, var="clinic") #var???clinic??????????????????

# -----9frailty??????????????????
coxph(Y ~ prison + dose + strata(clinic), data = addicts)
#frailty(p=0.31???????????????????????????frailty?????????????????????)
coxph(Y ~ prison + dose + strata(clinic) + frailty(id, distribution = "gamma") , data = addicts)


addicts
